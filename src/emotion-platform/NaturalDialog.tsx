"use client"

import React, { useState, useEffect, useRef } from 'react'
import { MessageCircle, Mic, Volume2, Heart, Brain, Sparkles, Send } from 'lucide-react'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Badge } from '@/components/ui/badge'\nimport { ScrollArea } from '@/components/ui/scroll-area'\nimport { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'\n\ninterface DialogMessage {\n  id: string\n  role: 'user' | 'assistant'\n  content: string\n  timestamp: number\n  emotion?: string\n  confidence?: number\n}\n\ninterface DialogContext {\n  topic: string\n  mood: string\n  userPreferences: string[]\n  conversationFlow: string[]\n}\n\ninterface NaturalDialogProps {\n  onMessageSent?: (message: DialogMessage) => void\n  onEmotionDetected?: (emotion: string, confidence: number) => void\n  userName?: string\n  assistantName?: string\n}\n\nexport const NaturalDialog: React.FC<NaturalDialogProps> = ({\n  onMessageSent,\n  onEmotionDetected,\n  userName = 'å­¦ä¹ è€…',\n  assistantName = 'AIåŠ©æ‰‹'\n}) => {\n  const [messages, setMessages] = useState<DialogMessage[]>([\n    {\n      id: '1',\n      role: 'assistant',\n      content: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ä¸“å±AIå­¦ä¹ ä¼™ä¼´ï¼Œä»Šå¤©æƒ³å­¦ä¹ ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä¼šæ ¹æ®ä½ çš„æƒ…ç»ªå’Œå­¦ä¹ çŠ¶æ€æ¥è°ƒæ•´æˆ‘çš„å›åº”æ–¹å¼å“¦ï¼ğŸ˜Š',\n      timestamp: Date.now() - 1000,\n      emotion: 'friendly',\n      confidence: 0.9\n    }\n  ])\n  \n  const [inputMessage, setInputMessage] = useState('')\n  const [isListening, setIsListening] = useState(false)\n  const [isTyping, setIsTyping] = useState(false)\n  const [dialogContext, setDialogContext] = useState<DialogContext>({\n    topic: 'ç¼–ç¨‹å­¦ä¹ ',\n    mood: 'encouraging',\n    userPreferences: ['å®è·µå¯¼å‘', 'äº’åŠ¨å¼å­¦ä¹ '],\n    conversationFlow: ['é—®å€™', 'éœ€æ±‚äº†è§£']\n  })\n  \n  const messagesEndRef = useRef<HTMLDivElement>(null)\n  const scrollAreaRef = useRef<HTMLDivElement>(null)\n\n  // æ»šåŠ¨åˆ°åº•éƒ¨\n  const scrollToBottom = () => {\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })\n  }\n\n  useEffect(() => {\n    scrollToBottom()\n  }, [messages])\n\n  // æ¨¡æ‹ŸAIæ™ºèƒ½å›å¤\n  const generateAIResponse = (userMessage: string, userEmotion: string = 'neutral') => {\n    const responses = {\n      encouraging: [\n        'å¤ªæ£’äº†ï¼ä½ çš„æƒ³æ³•å¾ˆæœ‰åˆ›æ„ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æŠŠå®ƒå®ç°å‡ºæ¥å§ï¼ğŸš€',\n        'æˆ‘èƒ½æ„Ÿå—åˆ°ä½ çš„å­¦ä¹ çƒ­æƒ…ï¼Œè¿™ç§ç§¯æçš„æ€åº¦ä¼šå¸®åŠ©ä½ æ›´å¿«è¿›æ­¥ï¼ğŸ’ª',\n        'å¾ˆå¥½çš„é—®é¢˜ï¼è®©æˆ‘ç”¨ä¸€ä¸ªæœ‰è¶£çš„æ–¹å¼æ¥ä¸ºä½ è§£ç­”...',\n      ],\n      supportive: [\n        'æˆ‘ç†è§£è¿™å¯èƒ½æœ‰äº›å›°éš¾ï¼Œä½†è¯·è®°ä½ï¼Œæ¯ä¸ªä¸“å®¶éƒ½æ›¾æ˜¯åˆå­¦è€…ã€‚è®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚',\n        'æ„Ÿè§‰æœ‰ç‚¹æŒ«æŠ˜æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œè®©æˆ‘ä»¬æ¢ä¸ªè§’åº¦æ¥çœ‹è¿™ä¸ªé—®é¢˜ï¼Œä¹Ÿè®¸ä¼šæœ‰æ–°çš„å‘ç°ï¼',\n        'ä¸ç”¨æ‹…å¿ƒï¼Œå­¦ä¹ å°±æ˜¯ä¸€ä¸ªä¸æ–­è¯•é”™çš„è¿‡ç¨‹ã€‚è®©æˆ‘æ¥å¸®ä½ æ¢³ç†ä¸€ä¸‹æ€è·¯...',\n      ],\n      curious: [\n        'å“‡ï¼Œä½ é—®äº†ä¸€ä¸ªéå¸¸æœ‰æ·±åº¦çš„é—®é¢˜ï¼è®©æˆ‘æ¥è¯¦ç»†ä¸ºä½ è§£é‡Š...',\n        'ä½ çš„å¥½å¥‡å¿ƒçœŸçš„å¾ˆæ£’ï¼è¿™æ­£æ˜¯æˆä¸ºä¼˜ç§€å¼€å‘è€…çš„é‡è¦å“è´¨ã€‚',\n        'å¾ˆé«˜å…´çœ‹åˆ°ä½ åœ¨æ·±å…¥æ€è€ƒï¼è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢è¿™ä¸ªæœ‰è¶£çš„æ¦‚å¿µ...',\n      ]\n    }\n    \n    const emotionResponses = responses.encouraging // é»˜è®¤é¼“åŠ±å‹\n    if (userEmotion === 'frustrated') return responses.supportive\n    if (userEmotion === 'curious') return responses.curious\n    \n    const randomResponse = emotionResponses[Math.floor(Math.random() * emotionResponses.length)]\n    return randomResponse\n  }\n\n  // æ£€æµ‹ç”¨æˆ·æƒ…æ„Ÿ\n  const detectUserEmotion = (message: string) => {\n    const frustrationWords = ['éš¾', 'ä¸æ‡‚', 'å¤æ‚', 'å›°æƒ‘', 'é”™è¯¯']\n    const excitementWords = ['å¤ªå¥½äº†', 'æ˜ç™½äº†', 'å­¦ä¼šäº†', 'æœ‰è¶£', 'é…·']\n    const questionWords = ['ä¸ºä»€ä¹ˆ', 'æ€ä¹ˆ', 'å¦‚ä½•', 'ä»€ä¹ˆ', 'å“ªä¸ª']\n    \n    if (frustrationWords.some(word => message.includes(word))) {\n      return { emotion: 'frustrated', confidence: 0.8 }\n    }\n    \n    if (excitementWords.some(word => message.includes(word))) {\n      return { emotion: 'excited', confidence: 0.9 }\n    }\n    \n    if (questionWords.some(word => message.includes(word))) {\n      return { emotion: 'curious', confidence: 0.7 }\n    }\n    \n    return { emotion: 'neutral', confidence: 0.5 }\n  }\n\n  // å‘é€æ¶ˆæ¯\n  const sendMessage = () => {\n    if (!inputMessage.trim()) return\n    \n    const userEmotion = detectUserEmotion(inputMessage)\n    \n    const userMessage: DialogMessage = {\n      id: `user-${Date.now()}`,\n      role: 'user',\n      content: inputMessage,\n      timestamp: Date.now(),\n      emotion: userEmotion.emotion,\n      confidence: userEmotion.confidence\n    }\n    \n    setMessages(prev => [...prev, userMessage])\n    onMessageSent?.(userMessage)\n    onEmotionDetected?.(userEmotion.emotion, userEmotion.confidence)\n    \n    setInputMessage('')\n    setIsTyping(true)\n    \n    // æ¨¡æ‹ŸAIæ€è€ƒæ—¶é—´\n    setTimeout(() => {\n      const aiResponse = generateAIResponse(inputMessage, userEmotion.emotion)\n      \n      const aiMessage: DialogMessage = {\n        id: `ai-${Date.now()}`,\n        role: 'assistant',\n        content: aiResponse,\n        timestamp: Date.now(),\n        emotion: 'helpful',\n        confidence: 0.9\n      }\n      \n      setMessages(prev => [...prev, aiMessage])\n      setIsTyping(false)\n      onMessageSent?.(aiMessage)\n      \n      // æ›´æ–°å¯¹è¯ä¸Šä¸‹æ–‡\n      setDialogContext(prev => ({\n        ...prev,\n        conversationFlow: [...prev.conversationFlow.slice(-5), 'ai_response']\n      }))\n    }, 1000 + Math.random() * 2000)\n  }\n\n  // è¯­éŸ³è¾“å…¥æ¨¡æ‹Ÿ\n  const toggleListening = () => {\n    setIsListening(!isListening)\n    if (!isListening) {\n      // æ¨¡æ‹Ÿè¯­éŸ³è¯†åˆ«\n      setTimeout(() => {\n        setInputMessage('è¿™æ˜¯é€šè¿‡è¯­éŸ³è¾“å…¥çš„æ¶ˆæ¯ç¤ºä¾‹')\n        setIsListening(false)\n      }, 2000)\n    }\n  }\n\n  const getEmotionIcon = (emotion: string) => {\n    const icons = {\n      friendly: 'ğŸ˜Š',\n      helpful: 'ğŸ¤',\n      excited: 'ğŸ‰',\n      curious: 'ğŸ¤”',\n      frustrated: 'ğŸ˜”',\n      neutral: 'ğŸ˜'\n    }\n    return icons[emotion as keyof typeof icons] || 'ğŸ’¬'\n  }\n\n  const getEmotionColor = (emotion: string) => {\n    const colors = {\n      friendly: 'text-green-600',\n      helpful: 'text-blue-600',\n      excited: 'text-yellow-600',\n      curious: 'text-purple-600',\n      frustrated: 'text-red-600',\n      neutral: 'text-gray-600'\n    }\n    return colors[emotion as keyof typeof colors] || 'text-gray-600'\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      {/* å¯¹è¯ä¸Šä¸‹æ–‡æ˜¾ç¤º */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <MessageCircle className=\"text-blue-500\" />\n            è‡ªç„¶å¯¹è¯ç³»ç»Ÿ\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex gap-4 mb-4\">\n            <div className=\"text-center\">\n              <div className=\"text-sm text-gray-500\">å½“å‰è¯é¢˜</div>\n              <Badge variant=\"outline\">{dialogContext.topic}</Badge>\n            </div>\n            \n            <div className=\"text-center\">\n              <div className=\"text-sm text-gray-500\">å¯¹è¯æ°›å›´</div>\n              <Badge variant=\"outline\">{dialogContext.mood}</Badge>\n            </div>\n            \n            <div className=\"text-center\">\n              <div className=\"text-sm text-gray-500\">è½®æ¬¡</div>\n              <Badge variant=\"outline\">{Math.floor(messages.length / 2)}</Badge>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* å¯¹è¯åŒºåŸŸ */}\n      <Card className=\"h-96\">\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-2\">\n              <Heart className=\"w-4 h-4 text-red-500\" />\n              <span className=\"text-sm font-medium\">æƒ…æ„ŸåŒ–å¯¹è¯</span>\n            </div>\n            {isTyping && (\n              <div className=\"flex items-center gap-1 text-sm text-gray-500\">\n                <Brain className=\"w-4 h-4 animate-pulse\" />\n                {assistantName} æ­£åœ¨æ€è€ƒ...\n              </div>\n            )}\n          </div>\n        </CardHeader>\n        \n        <CardContent className=\"p-0 flex-1\">\n          <ScrollArea className=\"h-64 px-4\" ref={scrollAreaRef}>\n            <div className=\"space-y-4\">\n              {messages.map((message) => (\n                <div\n                  key={message.id}\n                  className={`flex gap-3 ${message.role === 'user' ? 'flex-row-reverse' : ''}`}\n                >\n                  <Avatar className=\"w-8 h-8\">\n                    <AvatarImage src={message.role === 'user' ? '/placeholder-user.webp' : '/placeholder-logo.svg'} />\n                    <AvatarFallback>\n                      {message.role === 'user' ? userName[0] : 'AI'}\n                    </AvatarFallback>\n                  </Avatar>\n                  \n                  <div className={`flex-1 ${message.role === 'user' ? 'text-right' : ''}`}>\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <span className=\"text-sm font-medium\">\n                        {message.role === 'user' ? userName : assistantName}\n                      </span>\n                      {message.emotion && (\n                        <span className={`text-xs ${getEmotionColor(message.emotion)}`}>\n                          {getEmotionIcon(message.emotion)}\n                        </span>\n                      )}\n                      <span className=\"text-xs text-gray-400\">\n                        {new Date(message.timestamp).toLocaleTimeString()}\n                      </span>\n                    </div>\n                    \n                    <div className={`p-3 rounded-lg max-w-md ${\n                      message.role === 'user' \n                        ? 'bg-blue-500 text-white ml-auto' \n                        : 'bg-gray-100 text-gray-900'\n                    }`}>\n                      {message.content}\n                    </div>\n                    \n                    {message.confidence && message.confidence > 0.7 && (\n                      <div className=\"text-xs text-gray-400 mt-1\">\n                        æƒ…æ„Ÿç½®ä¿¡åº¦: {(message.confidence * 100).toFixed(0)}%\n                      </div>\n                    )}\n                  </div>\n                </div>\n              ))}\n              <div ref={messagesEndRef} />\n            </div>\n          </ScrollArea>\n        </CardContent>\n      </Card>\n\n      {/* è¾“å…¥åŒºåŸŸ */}\n      <Card>\n        <CardContent className=\"p-4\">\n          <div className=\"flex gap-2\">\n            <Input\n              value={inputMessage}\n              onChange={(e) => setInputMessage(e.target.value)}\n              placeholder={isListening ? \"æ­£åœ¨å¬å–è¯­éŸ³è¾“å…¥...\" : \"è¾“å…¥ä½ æƒ³è¯´çš„è¯...\"}\n              onKeyPress={(e) => e.key === 'Enter' && sendMessage()}\n              disabled={isListening || isTyping}\n              className={isListening ? \"border-red-300 bg-red-50\" : \"\"}\n            />\n            \n            <Button\n              onClick={toggleListening}\n              variant={isListening ? \"destructive\" : \"outline\"}\n              size=\"icon\"\n              disabled={isTyping}\n            >\n              <Mic className={`w-4 h-4 ${isListening ? 'animate-pulse' : ''}`} />\n            </Button>\n            \n            <Button\n              onClick={sendMessage}\n              disabled={!inputMessage.trim() || isTyping || isListening}\n            >\n              <Send className=\"w-4 h-4\" />\n            </Button>\n          </div>\n          \n          <div className=\"flex justify-between items-center mt-3 text-xs text-gray-500\">\n            <div className=\"flex items-center gap-4\">\n              <span className=\"flex items-center gap-1\">\n                <Sparkles className=\"w-3 h-3\" />\n                æ™ºèƒ½æƒ…æ„Ÿè¯†åˆ«\n              </span>\n              <span className=\"flex items-center gap-1\">\n                <Brain className=\"w-3 h-3\" />\n                ä¸Šä¸‹æ–‡ç†è§£\n              </span>\n              <span className=\"flex items-center gap-1\">\n                <Heart className=\"w-3 h-3\" />\n                ä¸ªæ€§åŒ–å›åº”\n              </span>\n            </div>\n            \n            <div>\n              æŒ‰å›è½¦å‘é€\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  )\n}